from github import Github
import asyncio

from .constants import GITHUB_ACCESS_TOKEN


REPO_DATA = []

def repo_stats(name, sort=None):
    return [{"contributors":50,"forks":372,"name":"astyanax","stars":1008},{"contributors":19,"forks":420,"name":"curator","stars":2013},{"contributors":40,"forks":262,"name":"Priam","stars":939},{"contributors":7,"forks":60,"name":"CassJMeter","stars":152},{"contributors":31,"forks":271,"name":"servo","stars":1304},{"contributors":2,"forks":95,"name":"aws-autoscaling","stars":414},{"contributors":41,"forks":279,"name":"netflix.github.com","stars":578},{"contributors":4,"forks":92,"name":"gradle-template","stars":227},{"contributors":33,"forks":423,"name":"archaius","stars":1977},{"contributors":20,"forks":436,"name":"asgard","stars":2206},{"contributors":44,"forks":1051,"name":"SimianArmy","stars":7196},{"contributors":24,"forks":163,"name":"governator","stars":721},{"contributors":10,"forks":68,"name":"netflix-commons","stars":134},{"contributors":68,"forks":2165,"name":"eureka","stars":7889},{"contributors":23,"forks":126,"name":"edda","stars":491},{"contributors":13,"forks":39,"name":"frigga","stars":24},{"contributors":10,"forks":112,"name":"blitz4j","stars":541},{"contributors":100,"forks":3596,"name":"Hystrix","stars":17581},{"contributors":14,"forks":228,"name":"Turbine","stars":752},{"contributors":38,"forks":737,"name":"ribbon","stars":2983},{"contributors":14,"forks":95,"name":"denominator","stars":509},{"contributors":26,"forks":162,"name":"karyon","stars":478},{"contributors":17,"forks":173,"name":"EVCache","stars":1172},{"contributors":13,"forks":168,"name":"aminator","stars":849},{"contributors":8,"forks":103,"name":"recipes-rss","stars":330},{"contributors":8,"forks":488,"name":"Cloud-Prize","stars":163},{"contributors":4,"forks":82,"name":"netflix-graph","stars":483},{"contributors":27,"forks":1501,"name":"zuul","stars":7672},{"contributors":12,"forks":170,"name":"suro","stars":726},{"contributors":3,"forks":40,"name":"brutal","stars":183},{"contributors":12,"forks":53,"name":"pytheas","stars":181},{"contributors":11,"forks":136,"name":"Lipstick","stars":443},{"contributors":3,"forks":45,"name":"NfWebCrypto","stars":193},{"contributors":22,"forks":282,"name":"genie","stars":1158},{"contributors":10,"forks":32,"name":"Nicobar","stars":166},{"contributors":6,"forks":28,"name":"glisten","stars":64},{"contributors":3,"forks":15,"name":"blesk","stars":53},{"contributors":58,"forks":394,"name":"dynomite","stars":3072},{"contributors":8,"forks":84,"name":"aegisthus","stars":293},{"contributors":11,"forks":56,"name":"zeno","stars":193},{"contributors":4,"forks":41,"name":"staash","stars":188},{"contributors":5,"forks":27,"name":"s3mper","stars":181},{"contributors":17,"forks":56,"name":"PigPen","stars":508},{"contributors":3,"forks":7,"name":"fabricator","stars":8},{"contributors":4,"forks":163,"name":"Fido","stars":798},{"contributors":29,"forks":80,"name":"dyno","stars":156},{"contributors":8,"forks":70,"name":"ReactiveLab","stars":196},{"contributors":14,"forks":67,"name":"msl","stars":528},{"contributors":97,"forks":688,"name":"security_monkey","stars":3642},{"contributors":30,"forks":101,"name":"spectator","stars":488},{"contributors":7,"forks":61,"name":"inviso","stars":184},{"contributors":9,"forks":119,"name":"sketchy","stars":912},{"contributors":17,"forks":201,"name":"atlas","stars":2378},{"contributors":11,"forks":20,"name":"AWSObjectMapper","stars":25},{"contributors":5,"forks":4,"name":"edda-client","stars":1},{"contributors":4,"forks":57,"name":"Workflowable","stars":363},{"contributors":10,"forks":60,"name":"Raigad","stars":317},{"contributors":10,"forks":86,"name":"Prana","stars":415},{"contributors":7,"forks":22,"name":"ocelli","stars":44},{"contributors":10,"forks":31,"name":"iep","stars":50},{"contributors":6,"forks":9,"name":"iep-shadow","stars":2},{"contributors":7,"forks":7,"name":"netflixoss-build-infrastructure","stars":12},{"contributors":3,"forks":92,"name":"Surus","stars":412},{"contributors":51,"forks":448,"name":"falcor","stars":9347},{"contributors":16,"forks":40,"name":"falcor-router","stars":95},{"contributors":14,"forks":17,"name":"falcor-express","stars":55},{"contributors":15,"forks":28,"name":"falcor-http-datasource","stars":49},{"contributors":18,"forks":230,"name":"vector","stars":3150},{"contributors":13,"forks":105,"name":"Fenzo","stars":662},{"contributors":8,"forks":57,"name":"security-bulletins","stars":348},{"contributors":15,"forks":39,"name":"ember-nf-graph","stars":239},{"contributors":5,"forks":14,"name":"rx-aws-java-sdk","stars":27},{"contributors":4,"forks":16,"name":"ember-nf-graph-examples","stars":11},{"contributors":7,"forks":12,"name":"falcor-path-syntax","stars":14},{"contributors":8,"forks":12,"name":"falcor-restify","stars":23},{"contributors":85,"forks":196,"name":"lemur","stars":1195},{"contributors":9,"forks":51,"name":"falcor-router-demo","stars":218},{"contributors":9,"forks":20,"name":"falcor-hapi","stars":51},{"contributors":7,"forks":44,"name":"falcor-express-demo","stars":216},{"contributors":4,"forks":9,"name":"falcor-restify-demo","stars":4},{"contributors":3,"forks":8,"name":"falcor-hapi-demo","stars":11},{"contributors":7,"forks":13,"name":"falcor-json-graph","stars":45},{"contributors":10,"forks":12,"name":"falcor-path-utils","stars":20},{"contributors":7,"forks":61,"name":"rend","stars":957},{"contributors":8,"forks":26,"name":"restful-jsonapi","stars":69},{"contributors":2,"forks":14,"name":"eureka-ui","stars":25},{"contributors":2,"forks":13,"name":"sleepy-puppy-docker","stars":39},{"contributors":11,"forks":49,"name":"lemur-docker","stars":120},{"contributors":2,"forks":4,"name":"webpack-parse-query","stars":6},{"contributors":9,"forks":55,"name":"dial-reference","stars":112},{"contributors":3,"forks":8,"name":"falcor-datasource-chainer","stars":3},{"contributors":4,"forks":5,"name":"vp9-dash","stars":30},{"contributors":13,"forks":43,"name":"photon","stars":143},{"contributors":2,"forks":6,"name":"eslint-config-netflix-dea","stars":12},{"contributors":9,"forks":16,"name":"runtime-health","stars":29},{"contributors":35,"forks":248,"name":"vmaf","stars":1128},{"contributors":6,"forks":35,"name":"osstracker","stars":295},{"contributors":2,"forks":6,"name":"reactivesocket-examples","stars":6},{"contributors":2,"forks":20,"name":"hal-9001","stars":166},{"contributors":12,"forks":110,"name":"metacat","stars":596},{"contributors":3,"forks":24,"name":"unleash","stars":400},{"contributors":2,"forks":3,"name":"techreports","stars":12},{"contributors":1,"forks":11,"name":"rend-lmdb","stars":50},{"contributors":21,"forks":159,"name":"bless","stars":2011},{"contributors":20,"forks":315,"name":"vizceral","stars":3148},{"contributors":2,"forks":13,"name":"vizceral-component","stars":37},{"contributors":4,"forks":42,"name":"dynomite-manager","stars":78},{"contributors":6,"forks":32,"name":"vizceral-react","stars":161},{"contributors":7,"forks":141,"name":"vizceral-example","stars":308},{"contributors":1,"forks":11,"name":"q","stars":43},{"contributors":3,"forks":8,"name":"eslint-config-netflix","stars":45},{"contributors":2,"forks":7,"name":"rend-http","stars":14},{"contributors":12,"forks":37,"name":"dyno-queues","stars":150},{"contributors":23,"forks":84,"name":"ndbench","stars":297},{"contributors":16,"forks":481,"name":"chaosmonkey","stars":6658},{"contributors":30,"forks":117,"name":"hollow","stars":823},{"contributors":77,"forks":557,"name":"conductor","stars":1881},{"contributors":4,"forks":8,"name":"bettertls","stars":63},{"contributors":3,"forks":24,"name":"hollow-reference-implementation","stars":25},{"contributors":17,"forks":140,"name":"hubcommander","stars":1063},{"contributors":4,"forks":5,"name":"batch_request_client","stars":20},{"contributors":4,"forks":6,"name":"ember-batch-request","stars":42},{"contributors":5,"forks":12,"name":"batch_request_api","stars":68},{"contributors":10,"forks":49,"name":"repokid","stars":473},{"contributors":7,"forks":20,"name":"pygenie","stars":36},{"contributors":5,"forks":73,"name":"vectorflow","stars":1003},{"contributors":11,"forks":97,"name":"titus","stars":1821},{"contributors":3,"forks":6,"name":"falcor-observable","stars":7},{"contributors":10,"forks":16,"name":"titus-api-definitions","stars":62},{"contributors":11,"forks":35,"name":"titus-control-plane","stars":219},{"contributors":1,"forks":0,"name":"metrics-client-go","stars":0},{"contributors":9,"forks":20,"name":"titus-executor","stars":165},{"contributors":12,"forks":127,"name":"concurrency-limits","stars":1743},{"contributors":10,"forks":43,"name":"iceberg","stars":288},{"contributors":3,"forks":11,"name":"sureal","stars":45},{"contributors":63,"forks":324,"name":"fast_jsonapi","stars":4338},{"contributors":2,"forks":8,"name":"codec_compare","stars":12},{"contributors":4,"forks":10,"name":"spectator-py","stars":22},{"contributors":3,"forks":7,"name":"atlas-docs","stars":4},{"contributors":16,"forks":114,"name":"flamescope","stars":1963},{"contributors":5,"forks":7,"name":"spectator-go","stars":25},{"contributors":2,"forks":4,"name":"spectator-rb","stars":2},{"contributors":49,"forks":8,"name":"yetch","stars":155},{"contributors":2,"forks":13,"name":"go-expect","stars":87},{"contributors":1,"forks":7,"name":"go-env","stars":48},{"contributors":1,"forks":1,"name":"signal-wrapper","stars":26},{"contributors":14,"forks":217,"name":"pollyjs","stars":7709},{"contributors":0,"forks":1,"name":"tslint-config-netflix","stars":11},{"contributors":4,"forks":6,"name":"spectator-cpp","stars":12},{"contributors":2,"forks":4,"name":"spectator-js","stars":13},{"contributors":3,"forks":1,"name":"nerror","stars":14},{"contributors":1,"forks":1,"name":"netflixoss-npm-build-infrastructure","stars":0},{"contributors":1,"forks":0,"name":"probnik","stars":20}]

    raw_data = _raw_repo_data(name)

    return raw_data


def _raw_repo_data(name):

    g = Github(GITHUB_ACCESS_TOKEN)
    github_org = g.get_organization(name)
    all_repos = github_org.get_repos()

    # build list of [ {name, stars, forks, contributors}, ''' ]
    data = []
    loop = asyncio.new_event_loop()
    for repo in all_repos:
        task = _get_stats(repo)
        future = loop.create_task(task)
    
    loop.run_until_complete(future)
    return REPO_DATA


async def _get_stats(repo):
    # lack of better way to get this, make another call
    all_contributors = repo.get_stats_contributors()
    if all_contributors is None:
        total_contributors = 0
    else:
        total_contributors = len(all_contributors)

    data = {
        "name" : repo.name,
        "stars" : repo.stargazers_count,
        "forks" : repo.forks,
        "contributors" : total_contributors
    }
    # not ideal but having issues returning data from async functions and time is an issue
    REPO_DATA.append(data)
